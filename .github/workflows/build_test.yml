name: Build and Test

on:
  pull_request:
    branches:
      - 'main'
  push:
    branches:
      - 'main'
      - 'chore/**'
      - 'docs/**'
      - 'feat/**'
      - 'feature/**'
      - 'fix/**'
      - 'refactor/**'
      - 'releases/**'
      - 'style/**'
      - 'test/**'
      - 'tech/**'

env:
  RUST_TARGET_PATH: pact-reference/rust/target
  BINARIES_PATH: Resources

jobs:
  sharedInputs:
    name: "Shared envs"
    runs-on: ubuntu-latest
    outputs:
      rust-target-path: ${{ env.RUST_TARGET_PATH }}
      binaries-path: ${{ env.BINARIES_PATH }}
    steps:
      - run: echo "Just a hacky workaround for passing envs to jobs expecting them... ¯\\_(ツ)_/¯"

  buildFFI:
    needs: [sharedInputs]
    uses: ./.github/workflows/build_rust_binaries.yml
    with:
      rust-target-path: ${{ needs.sharedInputs.outputs.rust-target-path }}
      binaries-path: ${{ needs.sharedInputs.outputs.binaries-path }}

  testMacOS14:
    needs: [sharedInputs, buildFFI]
    uses: ./.github/workflows/test_macos14_x86_64.yml
    with:
      rust-target-path: ${{ needs.sharedInputs.outputs.rust-target-path }}
      binaries-path: ${{ needs.sharedInputs.outputs.binaries-path }}

  testMacOS13:
    needs: [sharedInputs, buildFFI]
    uses: ./.github/workflows/test_macos13_x86_64.yml
    with:
      rust-target-path: ${{ needs.sharedInputs.outputs.rust-target-path }}
      binaries-path: ${{ needs.sharedInputs.outputs.binaries-path }}
